
@using PokemonCards.Models;
@using PokemonCards.Models.Libs;

@{
    var action = Request.QueryString["action"];
    var id = Request.QueryString["id"];

    int team_id = Request.QueryString["team_id"] == null ? 0 : Convert.ToInt32(Request.QueryString["team_id"]);

    //If team_id was not passed through request
    //Check if the cookie has the team_id
    //if not create a new team_id
    if (team_id == 0)
    {
        HttpCookie hc = Request.Cookies["team_id"];
        if (hc != null)
        {
            team_id = Convert.ToInt32(hc["id"]);
        }
        else
        {
            team_id = TeamBuilder.CreateTeam();
            HttpCookie cookie = new HttpCookie("team_id");
            cookie["id"] = team_id.ToString();
            cookie.Expires = DateTime.Now.AddMonths(1);
            Request.Cookies.Add(cookie);
        }
    }

    string message = "";
    bool actionCompleted = false;

    //If action and id are not null
    //this means we are trying to add/remove
    //a pokemon from the team
    if (action != null && id != null)
    {
        actionCompleted = TeamBuilder.TeamPokemonAction(team_id, action, Convert.ToInt32(id));

        if (actionCompleted)
        {
            if (action == "add")
            {
                message = "Successfully added.";
            }
            else if (action == "remove")
            {
                message = "Successfully removed.";
            }
            else
            {
                message = "Error processing request.";
            }
        }
        else
        {
            message = "Error processing request.";
        }

    }


    //Data for page
    List<TeamPokemonModel> teamPoke = TeamBuilder.GetTeam(team_id);
    List<PokemonModel> allPoke = Pokemon.GetPokemon();

    ViewBag.Title = "Team Builder";
}

<div class="jumbotron bg-secondary text-light">
    <p class="lead">Create a team of 5 pokemon to battle with. Click on a Pokemon below to add them to your team.</p>
    <p class="@(actionCompleted?"text-success":"text-warning")">@message</p>
    <hr />
    <!-- Pokemon Team -->
    <h4 align="center">Your Team</h4>
    <div class="row">
        @foreach (var n in teamPoke)
        {
            <div class="col">
                <div class="card text-dark">
                    <img src="~/Content/@n.pokemon.GetDisplayImage()" class="card-img-top" alt="...">
                    <div class="card-body">
                        <h5 class="card-title">@n.pokemon.name</h5>
                        <p class="card-text">
                            Weight: @n.pokemon.weight
                            <br>
                            Health Points: @n.pokemon.hp
                            <br>
                            Level: @n.pokemon.level
                        </p>
                        <a href="/TeamBuilder/Index?action=remove&id=@n.pokemon.id&team_id=@team_id" class="btn btn-primary">Remove From Team</a>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<!-- All Pokemon -->
<div class="container-fluid">
    <h3>Pokemon</h3>
    <div class="row">
        @foreach (var n in allPoke)
        {
            <div class="col">
                <div class="card text-dark">
                    <img src="~/Content/@n.GetDisplayImage()" class="card-img-top" alt="...">
                    <div class="card-body">
                        <h5 class="card-title">@n.name</h5>
                        <p class="card-text">
                            Weight: @n.weight
                            <br>
                            Health Points: @n.hp
                            <br>
                            Level: @n.level
                        </p>
                        <a href="/TeamBuilder/Index?action=add&id=@n.id&team_id=@team_id" class="btn btn-primary">Add To Team</a>
                    </div>
                </div>
            </div>
        }
    </div>
</div>